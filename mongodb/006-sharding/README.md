# 006 - 数据分片

## 1. 概念

``` js
复制集—————————————————— > 高可用性、 数据安全
数据库分片—————————————— > 可扩展性
```

## 2. 纵向扩展

* 增强单一服务器的性能
* 简单的架构和运维模型
* 单一服务器的性能上限

## 3. 横向扩展

* 增加提供服务的服务器数量
* 更高的可扩展性
* 增加架构和运维的复杂度

## 4. 分片集群结构

一个集群包含的组件：

1. mongos（一般和 App Server 一起放在同一台机器，但也可以放在不同的机器上）
2. 各个分片（每个分片一般保存在不同的服务器上）
3. 配置服务器

* 每个分片存储一部分数据，可以部署为复制集
* mongos 路由可以将客户请求发送至相关的分片
* 配置服务器保存集群配置和元数据，可以部署为复制集

### 主分片

MongoDB 允许集合不分片，它们放在一起叫做 `主分片` 

* 集群中的每个数据库都会选择一个分片作为主分片
* 主分片存储所有不需要分片的集合
* 创建数据库时，数据最少的分片被选为主分片

## 5. 分片依据——片键

* 片键值被用来将集合中的文档划分为数据段
* 片键必须对应一个索引或索引前缀（单键或复合键）
* 可以使用片键值的哈希值来生成哈希片键

### 如何选择片键

| 要求                                                         | 解决方案               |
| ------------------------------------------------------------ | ---------------------- |
| 片键值的范围应该更广                                         | 可使用复合片键扩大范围 |
| 片键值的分布应该更平衡                                       | 可使用复合片键平衡分布 |
| 片键值不要单向增大/减小, 比如自动生成的ObjectId（因为可能也会导致文档分配不平衡） | 可使用哈希片键         |

## 6. 动态平衡

### 数据段分裂

* 数据段尺寸过大或包含过多文档时触发数据段分裂
* 只有新增/更新文档时才可能自动触发数据段分裂
* 数据段分裂通过更新元数据来实现

### 集群的平衡

分片之间包含的数据段差额较大，MongoDB 后台的平衡器将进行数据迁移，使集群中的分片平衡。

* 后台运行的平衡器负责监视和调整集群的平衡
* 当最大和最小分片之间的数据段数量相差过大时触发
* 集群中添加或移除分片时也会触发

## 7. 分片集群——配置服务器

* 存储各分片数据段列表和数据段范围
* 存储集群的认证和授权配置
* 不同的集群不要共用配置服务器

### 配置服务器以复制集

* 主节点故障时，在暂时没有主节点时，配置服务器进入**只读模式**
* 只读模式下， `数据段分裂` 和 `集群平衡` 都不可执行
* 整个复制集故障时，分片集群不可用

## 8. Mongos(路由)

### 分片查询

* 客户请求应发给 mongos，而不是分片服务器
* 当查询包含分片片键时，mongos 将查询发送到指定分片
* 当查询字段不包含分片片键时，mongos 将查询发送到所有分片，并汇总所有查询结果
