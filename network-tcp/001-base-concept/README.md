# 基础概念
先扫盲：

frame对应mac，packet对应ip，datagram对应udp，segment对应tcp，message对应app。

上问题：

1. 请画出三次握手和四次挥手的示意图
2. 为什么连接的时候是三次握手？
3. 什么是半连接队列？
4. ISN(Initial Sequence Number)是固定的吗？
5. 三次握手过程中可以携带数据吗？
6. 如果第三次握手丢失了，客户端服务端会如何处理？
7. SYN攻击是什么？
8. 挥手为什么需要四次？
9. 四次挥手释放连接时，等待2MSL的意义?

随着对网络的理解深入，明白TCP报文是交由IP网络来负责运输，IP网络并不能保证TCP报文到达目的地，既然IP网络是指望不上了，那TCP就自力更生吧，TCP必须依赖自身的努力来保证数据传输的可靠。

TCP看似复杂，其实可以归纳为以下5种报文：

（1）SYN

（2）Data（唯一携带用户数据）

（3）FIN

（4）Reset

（5）ACK

其中1、2、3分别为**建立连接、数据传输、断开连接**，这**三种报文对方接收到一定要ACK确认**，为何要确认，因为这就是可靠传输的依赖的机制。如果对方在**超时时间内不确认，发送方会一直重传**，直到对方确认为止、**或到达重传上限次数而Reset连接。**

4、5 为**重置连接报文、确认ACK报文**，这两种报文对方接收到要ACK确认吧？不需要！自然发送方也不会重传这2种类型的报文。

**为何Reset报文不需要ACK确认?**

因为发送Reset报文的一端，在发送完这个报文之后，和该TCP Session有关的内存结构体瞬间全部释放，无论对方收到或没有收到，关系并不大。

如果对方收到Reset报文，也会释放该TCP Session 的相关内存结构体。

如果对方没有收到Reset 报文，可能会继续发送让接收方弹射出Reset报文的报文，到最后对方一样会收到Reset 报文，并最终释放内存。

**为何ACK报文不需要ACK确认?**

这里的ACK报文，是指没有携带任何数据的裸ACK报文，对方收到这样的ACK报文，自然也不需要ACK。否则，对方为了ACK己方的ACK，那己方收到对方的ACK，也要ACK对方的ACK，这就是一个死循环，永无止息。

所以为了避免这个死循环，一律不允许ACK对方的裸ACK报文。

有同学会说，按照这么说，TCP连接应该是四次消息交互啊。

**1.A 发送SYN 报文给B，这是第一次报文交互。**

**2. B发送ACK确认A的SYN报文，这是第二次报文交互**

**3. B发送自己的SYN报文给A，这是第三次报文交互**

**4. A需要ACK确认B的SYN报文，这是第四次报文交互**

以上的演绎没有问题，但是报文2、3为何要分开发送呢？增加了延迟不说，同时还白白浪费了网络的带宽，完全可以将报文2、3合并起来，不就是在报文2的ACK状态位的位置置“1”就结了吗？

这就是三次消息交互的由来！

