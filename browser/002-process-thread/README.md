# 002-进程和线程

<motto></motto>

## 一、什么是并行处理

计算机中的并行处理就是 `同一时刻处理多个任务` 。

那么，我们知道多线程是可以并行处理任务的。下面就来看下到底什么是进程和线程。

## 二、进程和线程的概念

`进程` 是CPU `资源分配` 的最小单位，是能拥有资源和独立运行的最小单位。一个进程就是一个程序的运行实例。

`线程` 是CPU `调度` 的最小单位，线程是不能单独存在的，它是由进程来启动和管理的，一个进程可以拥有多个线程。

其实进程就是，启动一个程序的时候，操作系统会为该程序创建一块内存，用来存放 `代码` 、 `运行中的数据` 和 `一个执行任务的主线程` ，我们把这样的一个运行环境叫 `进程` 。

**线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率**。

## 三、进程线程之间的关系

1. 进程中的任意一线程执行出错，都会导致整个进程的崩溃。
2. 线程之间共享进程中的数据。
3. 当一个进程关闭之后，操作系统会回收进程所占用的内存。
4. 进程之间的内容相互隔离。

当然，进程之间肯定是可以进行通信的，但通常，进程之间是一个隔离状态的，每一个进程只能访问自己占有的数据，这就避免了内存中数据的错误读写，同时也保证了即便在另一个进程崩溃的情况下，其它进程不受影响。

如果进程之间需要进行数据的通信，这时候，就需要使用用于进程间通信（IPC）的机制了。

> 既然说到了进程线程，作为前端，当然要来扯一下浏览器啦

## 四、单进程浏览器

单进程浏览器是指浏览器的所有功能模块都是运行在同一个进程里。

这些模块包含了网络、插件、JavaScript 运行环境、渲染引擎和页面等。

2007 年之前，市面上浏览器都是单进程的。

## 五、单进程浏览器的问题

* 不稳定
* 不流畅
* 不安全（ `插件` 可以获取到操作系统的任意资源和 `页面脚本` 可以通过浏览器的漏洞来获取系统权限，这些脚本获取系统权限之后可以对你的电脑做一些恶意的事情）

### 单进程浏览器为何不可以采用多进程浏览器使用的安全沙箱机制？

因为只有一个主进程。

如果一个进程使用了安全沙箱之后，该进程对于操作系统的权限就会受到限制，比如不能对一些位置的文件进行读写操作，**而这些权限浏览器主进程所需要的，所以安全沙箱是不能应用到浏览器主进程之上的**。

## 六、早期多进程的浏览器

主进程 渲染进程 插件进程

### 1. 解决不稳定的问题

由于进程是相互隔离的，所以当一个页面或者插件崩溃时，影响到的仅仅是当前的页面进程或者插件进程，并不会影响到浏览器和其他页面，这就完美地解决了页面或者插件的崩溃会导致整个浏览器崩溃，也就是不稳定的问题。

### 2. 解决不流畅的问题

同样，JavaScript 也是运行在渲染进程中的，所以即使 JavaScript `阻塞` 了渲染进程，影响到的也只是当前的渲染页面，而并不会影响浏览器和其他页面，因为其他页面的脚本是运行在它们自己的渲染进程中的。所以当我们再在 Chrome 中运行上面那个死循环的脚本时，没有响应的仅仅是当前的页面。

对于 `内存泄漏` 的解决方法那就更简单了，因为当关闭一个页面时，整个渲染进程也会被关闭，之后该进程所占用的内存都会被系统回收，这样就轻松解决了浏览器页面的内存泄漏问题。

### 3. 解决两个安全问题(插件和脚本)

采用多进程架构的额外好处是可以使用安全沙箱，你可以把沙箱看成是操作系统给进程上了一把锁，沙箱里面的程序可以运行，但是不能在你的硬盘上写入任何数据，也不能在敏感位置读取任何数据，例如你的文档和桌面。

Chrome 把插件进程和渲染进程锁在沙箱里面，这样即使在渲染进程或者插件进程里面执行了恶意程序，恶意程序也无法突破沙箱去获取系统权限。

## 七、现代多进程架构

* 主进程
* 渲染进程
* 插件进程
* GPU进程
* 网络进程

浏览器是多进程的，有一个主控进程，以及每一个tab标签页面都会开一个进程。

### 1. 特殊情况(某些情况下多个tab由于优化策略会合并为一个进程)

某些情况下多个tab由于优化策略会合并为一个进程

通常情况下是一个页面使用一个进程，但是，有一种情况，叫"同一站点(same-site)"。

具体地讲，要想为“同一站点”，那么就必须 `根域名` （例如，geekbang.org）加上 `协议` （例如，https:// 或者http://）相同。对该根域名下的子域名和端口不做要求，比如下面这三个：

https://blog.baitang.com
https://www.baitang.com
https://www.baitang.com:8080
都是属于同一站点，因为它们的协议都是https，而根域名也都是baitang.com。

当然了，在这里，我们可能会想到 `同源策略` ，但是 `同一站点` 和 `同源策略` 是不同的，[同源策略详情](http://blog.lskreno.top/interview/003-cross-orign/#什么是源？)。

**Chrome的默认策略是，每个标签对应一个渲染进程。但是如果从一个页面打开了新页面，而新页面和当前页面属于同一站点时，那么新页面会复用父页面的渲染进程。官方把这个默认策略叫process-per-site-instance。**

直白的讲，就是如果几个页面符合同一站点，那么他们将被分配到一个渲染进程里面去。

所以，这种情况下，一个页面崩溃了，会导致同一站点的页面同时崩溃，因为他们使用了同一个渲染进程。

#### 为什么要让他们跑在一个进程里面呢？

因为在一个渲染进程里面，他们就会 `共享JS的执行环境` ，也就是说 `A页面可以直接在B页面中执行脚本` 。因为是同一家的站点，所以是有这个需求的。

### 2. 浏览器多进程的优势

#### （1）稳定性提高

* 避免单个page crash影响整个浏览器；
* 避免第三方插件crash影响整个浏览器

#### （2）流畅性提高

* 多进程充分利用多核优势

#### （3）安全性提高

* 方便使用沙盒模型隔离插件，页面脚本等进程，提高浏览器安全性和稳定性

### 3. 浏览器多进程的缺点

多进程内存消耗会很大，有点空间换时间的感觉。

## 八、未来

面向服务架构(SOA)

